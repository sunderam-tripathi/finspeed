name: Test OIDC Authentication

on:
  workflow_dispatch:
  push:
    branches: [feat/p1-local-dev-setup]

jobs:
  test-oidc-staging:
    runs-on: ubuntu-latest
    environment: staging
    
    permissions:
      contents: read
      id-token: write  # Required for OIDC token generation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER_STAGING }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT_STAGING }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: finspeed-staging
      
      - name: Test Authentication
        run: |
          echo "🔐 Testing OIDC Authentication..."
          
          # Test basic authentication
          gcloud auth list
          
          # Test project access
          gcloud config get-value project
          
          # Test specific permissions
          echo "📋 Testing permissions..."
          gcloud projects describe finspeed-staging
          
          # Test Terraform state access
          echo "🗄️ Testing Terraform state access..."
          gsutil ls gs://finspeed-terraform-state/
          
          # Test Cloud Run permissions
          echo "🚀 Testing Cloud Run permissions..."
          gcloud run services list --region=us-central1
          
          echo "✅ OIDC Authentication test completed successfully!"
