name: Deploy Staging

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

env:
  PROJECT_ID_STAGING: finspeed-staging
  REGION: us-central1

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER_STAGING }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT_STAGING }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID_STAGING }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0 # Or your desired version

      - name: Create GCS Backend Bucket if it doesn't exist
        run: |
          gcloud storage buckets describe gs://finspeed-tfstate-${{ env.PROJECT_ID_STAGING }} || \
          gcloud storage buckets create gs://finspeed-tfstate-${{ env.PROJECT_ID_STAGING }} --project=${{ env.PROJECT_ID_STAGING }} --location=${{ env.REGION }} --uniform-bucket-level-access

      - name: Terraform Apply
        run: |
          terraform init -backend-config="bucket=finspeed-tfstate-${{ env.PROJECT_ID_STAGING }}" -reconfigure
          terraform workspace select staging || terraform workspace new staging
          terraform apply -auto-approve -var-file="environments/staging.tfvars"
        working-directory: ./infra/terraform

      - name: Build and Deploy Applications
        run: |
          echo "üöÄ Building and deploying applications to staging..."
          export IMAGE_TAG=$GITHUB_SHA
          export API_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID_STAGING }}/finspeed/api:$IMAGE_TAG"
          export FRONTEND_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID_STAGING }}/finspeed/frontend:$IMAGE_TAG"
          gcloud artifacts repositories create finspeed --repository-format=docker --location=${{ env.REGION }} --description="Finspeed application images" || echo "Repository already exists"
          echo "üì¶ Building API container..."
          docker build -t $API_IMAGE -f ./api/Dockerfile .
          docker push $API_IMAGE
          echo "üì¶ Building Frontend container..."
          docker build -t $FRONTEND_IMAGE -f ./frontend/Dockerfile .
          docker push $FRONTEND_IMAGE
          echo "üóÑÔ∏è Ensuring database migration job exists..."
          # Check if the job exists. If not, create it. This makes the workflow idempotent.
          gcloud run jobs describe finspeed-migrate-staging --region=${{ env.REGION }} >/dev/null 2>&1 || \
            gcloud run jobs create finspeed-migrate-staging \
              --image=$API_IMAGE \
              --region=${{ env.REGION }} \
              --service-account=${{ secrets.WIF_SERVICE_ACCOUNT_STAGING }} \
              --set-secrets=DATABASE_URL=finspeed-database-url-staging:latest \
              --vpc-connector=finspeed-vpc-staging \
              --vpc-egress=private-ranges-only \
              --command=./main \
              --args=migrate,up

          echo "üîÑ Updating and running database migrations..."
          gcloud run jobs update finspeed-migrate-staging --image=$API_IMAGE --region=${{ env.REGION }} --service-account=${{ secrets.WIF_SERVICE_ACCOUNT_STAGING }} --vpc-connector=finspeed-vpc-staging --vpc-egress=private-ranges-only --command=./main --args=migrate,up
          gcloud run jobs execute finspeed-migrate-staging --region=${{ env.REGION }} --wait
          echo "üöÄ Deploying API to Cloud Run..."
          gcloud run deploy finspeed-api-staging \
            --image=$API_IMAGE \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --set-secrets=DATABASE_URL=finspeed-database-url-staging:latest,JWT_SECRET=finspeed-jwt-secret-staging:latest \
            --set-env-vars=GIN_MODE=release,ENVIRONMENT=staging,LOG_LEVEL=info
          echo "üöÄ Deploying Frontend to Cloud Run..."
          gcloud run deploy finspeed-frontend-staging \
            --image=$FRONTEND_IMAGE \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=3000 \
            --set-env-vars="NEXT_PUBLIC_API_URL=https://api.finspeed.online,NODE_ENV=production"
          echo "‚úÖ Deployment completed successfully!"

      - name: Get IAP Client ID
        id: get_iap_client_id
        run: |
          echo "iap_client_id=$(terraform output -raw iap_client_id)" >> $GITHUB_ENV
        working-directory: ./infra/terraform

      - name: Run Smoke Tests
        run: |
          echo "üß™ Running smoke tests..."
          echo "üîë Minting IAP token..."
          IAP_TOKEN=$(gcloud auth print-identity-token --audiences=$iap_client_id)
          export API_URL="https://api.finspeed.online"
          export FRONTEND_URL="https://finspeed.online"
          echo "Polling /healthz endpoint..."
          SUCCESS=false
          for i in {1..12}; do
            if curl --fail --silent --show-error --retry 5 --retry-delay 10 --retry-connrefused -H "Authorization: Bearer $IAP_TOKEN" "$API_URL/healthz"; then
              echo "‚úÖ API /healthz endpoint is healthy."
              SUCCESS=true
              break
            fi
            echo "Attempt $i/12 failed. Retrying in 10 seconds..."
            sleep 10
          done
          if [ "$SUCCESS" = false ]; then
            echo "‚ùå API /healthz endpoint did not become healthy in time."
            exit 1
          fi
          echo "Testing API products endpoint..."
          curl -f -H "Authorization: Bearer $IAP_TOKEN" "$API_URL/api/v1/products" || (echo "‚ùå API products endpoint failed" && exit 1)
          echo "Testing API categories endpoint..."
          curl -f -H "Authorization: Bearer $IAP_TOKEN" "$API_URL/api/v1/categories" || (echo "‚ùå API categories endpoint failed" && exit 1)
          echo "Testing Frontend homepage..."
          curl -f -H "Authorization: Bearer $IAP_TOKEN" "$FRONTEND_URL" || (echo "‚ùå Frontend homepage failed" && exit 1)
          echo "‚úÖ All smoke tests passed!"